- hosts: all
  become: yes

  tasks:
    # - name: Get base playbook
    #   get_url: url=https://raw.githubusercontent.com/Sage-Bionetworks/packer-base-ubuntu-bionic/v1.0.0/src/playbook.yaml dest={{ playbook_dir }}/sagebio-base-ubuntu-bionic-v1.0.0.yaml

    # - include_tasks: sagebio-base-ubuntu-bionic-v1.0.0.yaml

    - name: Add the CRAN apt key
      apt_key:
        keyserver: keyserver.ubuntu.com
        id: E298A3A825C0D65DFD57CBB651716619E084DAB9

    - name: Add R-Project apt repository
      shell: "aptdcon --add-repository 'deb https://cloud.r-project.org/bin/linux/ubuntu {{ ansible_distribution_release }}-cran35/' && aptdcon --refresh"

    - name: install packages
      shell: "yes | aptdcon --hide-terminal --install 'zlib1g-dev libclang-dev libssl-dev libffi-dev libcurl4-openssl-dev libapparmor1 libssl1.0.0 r-base r-base-dev libxml2-dev apache2 libmemcached11 libjansson4 libcjose0 libhiredis0.13 ssl-cert'"

    - name: Download OAUTH2 library 
      get_url: url=https://github.com/zmartzone/liboauth2/releases/download/v1.3.0/liboauth2_1.3.0-1.bionic+1_amd64.deb dest=/tmp/liboauth2.deb

    - name: Install OAUTH2 library 
      command: dpkg -i /tmp/liboauth2.deb

    - name: Download OAUTH2 apache2 binding 
      get_url: url=https://github.com/zmartzone/liboauth2/releases/download/v1.3.0/liboauth2-apache_1.3.0-1.bionic+1_amd64.deb dest=/tmp/liboauth2-apache.deb

    - name: Install OAUTH2 apache2 binding 
      command: dpkg -i /tmp/liboauth2-apache.deb

    - name: Download OAUTH2 apache2 module 
      get_url: url=https://github.com/zmartzone/mod_oauth2/releases/download/v3.1.0/libapache2-mod-oauth2_3.1.0-1.bionic+1_amd64.deb dest=/tmp/liboauth2-apache-module.deb

    - name: Install OAUTH2 apache2 module 
      command: dpkg -i /tmp/liboauth2-apache-module.deb

    - name: Download RStudio Server
      get_url: url=https://download2.rstudio.org/server/bionic/amd64/rstudio-server-1.2.5033-amd64.deb dest=/tmp/rstudio.deb

    - name: Install RStudio Server
      command: dpkg -i /tmp/rstudio.deb

    - name: Overwrite rstudio web config
      copy:
        dest: /etc/rstudio/rserver.conf
        content: |
          www-address=127.0.0.1  #Only serve on internal interface
          www-port=8787
          #TODO need to disable local auth

    - name: Add config for local rev proxy to internal port
      copy:
        src: proxy.conf
        dest: /etc/apache2/sites-available/proxy.conf

    - name: Enable ssl proxy modules
      command: a2enmod ssl proxy proxy_http oauth2

    - name: Add normal symlink convention
      file:
        src: /etc/apache2/site-available/proxy.conf
        dest: /etc/apache2/sites-enabled/proxy.conf
        state: link

    - name: Remove default enabled site
      file:
        src: /etc/apache2/sites-enabled/000-default.conf
        state: absent

    # Install essential R packages
    - name: Install synapser
      shell: "R -e \"install.packages('synapser', repos=c('http://ran.synapse.org', 'http://cran.fhcrc.org'))\""

