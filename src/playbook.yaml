- hosts: all
  become: yes

  tasks:
    - name: Wait for automatic Ubuntu updates
      become: yes
      shell: while sudo fuser /var/lib/dpkg/lock >/dev/null 2>&1; do sleep 1; done;

    - name: Add the CRAN apt key
      apt_key:
        keyserver: keyserver.ubuntu.com
        id: E298A3A825C0D65DFD57CBB651716619E084DAB9

    - name: Add R-Project apt repository
      apt_repository:
        repo: deb https://cloud.r-project.org/bin/linux/ubuntu {{ ansible_distribution_release }}-cran35/
        update_cache: yes

    - name: install packages
      package:
        name:
          - "zlib1g-dev"
          - "libclang-dev"
          - "libssl-dev"
          - "libffi-dev"
          - "libcurl4-openssl-dev"
          - "libapparmor1"
          - "libssl1.0.0"
          - "r-base"
          - "r-base-dev"
          - "libxml2-dev"
          - "nginx"
        state: present

    - name: Download RStudio Server
      get_url: url=https://download2.rstudio.org/server/bionic/amd64/rstudio-server-1.2.5033-amd64.deb dest=/tmp/rstudio.deb

    - name: Install RStudio Server
      command: dpkg -i /tmp/rstudio.deb

    - name: Overwrite rstudio web config
      copy:
        dest: /etc/rstudio/rserver.conf
        content: |
          www-address=127.0.0.1  #Only serve on internal interface
          www-port=8787

    #Create nginx proxy
    - name: Create folder for ssl certs
      file:
        path: /etc/nginx/ssl
        state: directory
        mode: 0700

    - name: Generate a priv key
      openssl_privatekey:
        path: /etc/nginx/ssl/rstudio.pem

    - name: Generate CSR
      openssl_csr:
        path: /etc/nginx/ssl/rstudio.csr
        privatekey_path: /etc/nginx/ssl/rstudio.pem
        common_name: rstudio.scipoolprod.org #This DNS name does not exist

    - name: Generate a self-signed cert
      openssl_certificate:
        path: /etc/nginx/ssl/rstudio.cert
        privatekey_path: /etc/nginx/ssl/rstudio.pem
        csr_path: /etc/nginx/ssl/rstudio.csr
        provider: selfsigned

    - name: Add config for local rev proxy to rstudio
      copy:
        dest: /etc/nginx/nginx.conf
        content: |
          user www-data;  #default web server user on Ubuntu (should be nginx for rpm installs)
          worker_processes auto;
          error_log /var/log/nginx/error.log;
          pid /var/run/nginx.pid;

          include /usr/share/nginx/modules/*.conf;

          events {
            worker_connections 1024;
          }

          http {
            log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                              '$status $body_bytes_sent "$http_referer" '
                              '"$http_user_agent" "$http_x_forwarded_for"';

            access_log  /var/log/nginx/access.log  main;

            sendfile            on;
            tcp_nopush          on;
            tcp_nodelay         on;
            keepalive_timeout   65;
            types_hash_max_size 2048;
            include             /etc/nginx/mime.types;
            default_type        application/octet-stream;

            server {
              listen 443 ssl;
              ssl_certificate /etc/nginx/ssl/rstudio.cert;
              ssl_certificate_key /etc/nginx/ssl/rstudio.pem;

              location / {
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_pass http://localhost:8787/;
                proxy_redirect http://localhost:8787/ $scheme://$host/;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_read_timeout 7d;
              }
            }

            index   index.html index.htm;
            server_names_hash_bucket_size 128;

            map $http_upgrade $connection_upgrade {
            default upgrade;
            ''      close;
            }
          }

    # Install essential R packages
    - name: Install synapser
      shell: "R -e \"install.packages('synapser', repos=c('http://ran.synapse.org', 'http://cran.fhcrc.org'))\""

    - name: Install tidyverse
      shell: "R -e \"install.packages('tidyverse')\""

    - name: Install devtools
      shell: "R -e \"install.packages('devtools')\""

    - name: Install BiocManager
      shell: "R -e \"install.packages('BiocManager')\""

   # reticulate has python path issues
   # - name: Install reticulate
   #   shell: "R -e \"install.packages('reticulate')\""

   # - pip:
   #     name: synapseclient
